<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Web App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            text-align: center;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            user-select: none;
            overflow: hidden;
            background-image: url('back.gif');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
        }

        .prompt {
            color: white;
            font-size: 24px;
            margin-bottom: 20px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            transition: opacity 0.5s ease;
        }

        /* Анимация исчезновения <н</н>адписи */
        .prompt.fade-out {
            opacity: 0;
        }

        .card-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            width: 90%;
            max-width: 600px;
            justify-items: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-wrapper {
            width: 100%;
            aspect-ratio: 1.85/3;
            transition: opacity 0.3s ease;
            position: relative;
        }

        .card {
            width: 100%;
            height: 100%;
            position: relative;
            perspective: 1000px;
            cursor: pointer;
            margin: 0;
            padding: 0;
            border-radius: 8px;
            transform-style: preserve-3d;
            transition: transform 0.6s ease, box-shadow 0.3s ease;
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card-front,
        .card-back {
            width: 100%;
            height: 100%;
            position: absolute;
            backface-visibility: hidden;
            border-radius: 8px;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
        }

        .card-front {
            background-position: center 61%;
            transform: rotateY(180deg);
        }

        .card-back {
            background-image: url('back3.png');
        }

        .card-flipped-glow {
            box-shadow: 0 0 10px 2px rgba(255, 255, 255, 0.7);
        }

        /* Анимация исчезновения невыбранных карт */
        .fading-card {
            opacity: 0 !important;
            transition: opacity 0.5s ease-out;
        }

        /* Контейнер для выбранных карт */
        .selected-row {
            position: fixed;
            top: 50%;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 10;
            padding: 0 20px;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .selected-card-wrapper {
            width: calc((90vw - 50px) / 3);
            aspect-ratio: 1.85/3;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* Анимация перемещения карт (редачить) */
        .flying-card {
            position: fixed;
            z-index: 100;
            transition: all 1s cubic-bezier(.8,.86,.4,1); /* https://cubic-bezier.com/#.2,.8,.4,1 /*
            transform-origin: center;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="prompt" id="prompt">Выберите 3 карты</div>
    <div class="card-container" id="card-container"></div>
    <div class="selected-row" id="selected-row"></div>

    <script>
        fetch('tarot_cards_full.json')
            .then(response => response.json())
            .then(data => {
                const cards = Object.entries(data);
                const selectedCards = getRandomCards(cards, 8);
                const cardContainer = document.getElementById('card-container');
                const selectedRow = document.getElementById('selected-row');
                const promptElement = document.getElementById('prompt');
                let clickCount = 0;
                const selectedCardsList = [];

                // Создаем обертки для выбранных карт
                for (let i = 0; i < 3; i++) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'selected-card-wrapper';
                    wrapper.dataset.index = i;
                    selectedRow.appendChild(wrapper);
                }

                // Добавляем карты в контейнер
                selectedCards.forEach((card, index) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'card-wrapper';
                    wrapper.style.opacity = '1';

                    const cardElement = document.createElement('div');
                    cardElement.className = 'card';
                    cardElement.dataset.index = index;

                    const cardFront = document.createElement('div');
                    cardFront.className = 'card-front';
                    cardFront.style.backgroundImage = `url('${card[0]}')`;

                    const cardBack = document.createElement('div');
                    cardBack.className = 'card-back';

                    cardElement.appendChild(cardFront);
                    cardElement.appendChild(cardBack);
                    wrapper.appendChild(cardElement);
                    cardContainer.appendChild(wrapper);

                    // Обработчик клика на обертку карты
                    wrapper.addEventListener('click', () => handleCardClick(cardElement, wrapper));
                });

                function handleCardClick(card, wrapper) {
                    if (!card.classList.contains('flipped') && clickCount < 3) {
                        card.classList.add('flipped');
                        clickCount++;

                        setTimeout(() => {
                            card.classList.add('card-flipped-glow');
                        }, 300);

                        selectedCardsList.push({card, wrapper});

                        if (clickCount === 3) {
                            // Плавно скрываем надпись
                            promptElement.classList.add('fade-out');

                            setTimeout(() => {
                                moveSelectedCards(selectedCardsList);
                            }, 500);
                        }
                    }
                }

                function moveSelectedCards(cards) {
                    // Скрываем невыбранные карты
                    const allWrappers = document.querySelectorAll('.card-wrapper');
                    allWrappers.forEach(wrapper => {
                        if (!cards.some(c => c.wrapper === wrapper)) {
                            wrapper.style.opacity = '0';
                        }
                    });

                    const targetWrappers = document.querySelectorAll('.selected-card-wrapper');

                    // Сначала скрываем все целевые позиции
                    targetWrappers.forEach(wrapper => {
                        wrapper.style.opacity = '0';
                        wrapper.innerHTML = '';
                    });

                    cards.forEach(({card, wrapper}, index) => {
                        const targetWrapper = targetWrappers[index];
                        const cardRect = card.getBoundingClientRect();
                        const targetRect = targetWrapper.getBoundingClientRect();

                        // Создаем летающую карту
                        const flyingCard = card.cloneNode(true);
                        flyingCard.className = 'card flipped card-flipped-glow flying-card';
                        flyingCard.style.width = `${cardRect.width}px`;
                        flyingCard.style.height = `${cardRect.height}px`;
                        flyingCard.style.left = `${cardRect.left}px`;
                        flyingCard.style.top = `${cardRect.top}px`;
                        document.body.appendChild(flyingCard);

                        // Скрываем оригинальную карту
                        wrapper.style.opacity = '0';

                        // Анимация движения
                        setTimeout(() => {
                            flyingCard.style.left = `${targetRect.left}px`;
                            flyingCard.style.top = `${targetRect.top}px`;
                            flyingCard.style.width = `${targetRect.width}px`;
                            flyingCard.style.height = `${targetRect.height}px`;

                            // После завершения анимации
                            setTimeout(() => {
                                // Удаляем летающую карту


                                // Создаем финальную карту в целевом положении
                                const finalCard = card.cloneNode(true);
                                finalCard.className = 'card flipped card-flipped-glow';
                                targetWrapper.appendChild(finalCard);
                                targetWrapper.style.opacity = '1';
                            }, 5000); // Должно совпадать с длительностью анимации
                        }, 100);
                        wrapper.style.opacity = '0';
                    });
                }

                function getRandomCards(cards, count) {
                    const shuffled = cards.sort(() => Math.random() - 0.5);
                    return shuffled.slice(0, count);
                }
            })
            .catch(error => console.error('Ошибка загрузки JSON:', error));
    </script>
</body>
</html>